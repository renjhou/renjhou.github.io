<!doctype html>
<html>
<head>
    <title>OpenCV Video Examples - Video</title>
    <link href="app.css" rel="stylesheet">
</head>
<body>
<h1>OpenCV Video</h1>
<video id="video" src="trailer.mp4" muted width="320" height="240"></video>
<canvas id="canvasOutput" width="320" height="240"></canvas>
<script async src="opencv.js" type="text/javascript" onload="onCvLoaded();"></script>
<script>
function onCvLoaded () {
    console.log('cv', cv);
    cv.onRuntimeInitialized = onReady;
}
const video = document.getElementById('video'); 
const FPS = 30;
let stream;
let streaming = false;
function onReady () {
    console.log('ready');
    let src;
    let dst;
    let cap; 
    let faces = new cv.RectVector();
    let classifier = new cv.CascadeClassifier(); 
    // load pre-trained classifiers
    classifier.load('haarcascade_frontalface_default.xml');


    video.controls = true;
    video.addEventListener('play', start);
    video.addEventListener('pause', stop);
    video.addEventListener('ended', stop);

    function start () {
        console.log('playing...');
        streaming = true;
        const width = video.width;
        const height = video.height;
        src = new cv.Mat(height, width, cv.CV_8UC4);
        dst = new cv.Mat(height, width, cv.CV_8UC1);
        cap = new cv.VideoCapture(video);
        setTimeout(processVideo, 0);
    }

    function stop () {
        console.log('paused or ended');
        streaming = false;
    }

    // function processVideo () {
    //     if (!streaming) {
    //         src.delete();
    //         dst.delete();
    //         return;
    //     }
    //     const begin = Date.now();
    //     cap.read(src)
    //     cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
    //     cv.imshow('canvasOutput', dst);
    //     const delay = 1000/FPS - (Date.now() - begin);
    //     setTimeout(processVideo, delay);
    // }


    function processVideo() {
        try {
            if (!streaming) {
                // clean and stop.
                src.delete();
                dst.delete();
                gray.delete();
                faces.delete();
                classifier.delete();
                return;
            }
            let begin = Date.now();
            // start processing.
            cap.read(src);
            src.copyTo(dst);
            cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
            // detect faces.
            classifier.detectMultiScale(gray, faces, 1.1, 3, 0);
            // draw faces.
            for (let i = 0; i < faces.size(); ++i) {
                let face = faces.get(i);
                let point1 = new cv.Point(face.x, face.y);
                let point2 = new cv.Point(face.x + face.width, face.y + face.height);
                cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);
            }
            cv.imshow('canvasOutput', dst);
            // schedule the next one.
            let delay = 1000/FPS - (Date.now() - begin);
            setTimeout(processVideo, delay);
        } catch (err) {
            utils.printError(err);
        }
    };
}

</script>
</body>
</html>